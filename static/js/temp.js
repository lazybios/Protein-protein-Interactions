
/*var ppi_json = {"nodes": [{"name": "orange1.1t04741.1", "center": "y"}, {"name": "Cs2g04850.2", "center": "n"}, {"name": "Cs9g02490.1", "center": "n"}, {"name": "Cs3g10670.2", "center": "n"}, {"name": "orange1.1t00168.1", "center": "n"}, {"name": "Cs6g16010.5", "center": "n"}, {"name": "Cs4g07670.1", "center": "n"}, {"name": "Cs9g03530.2", "center": "n"}, {"name": "Cs3g25060.2", "center": "n"}, {"name": "Cs2g09970.1", "center": "n"}, {"name": "Cs3g16020.8", "center": "n"}, {"name": "Cs1g21530.1", "center": "n"}, {"name": "Cs8g10160.2", "center": "n"}, {"name": "Cs9g05750.3", "center": "n"}, {"name": "orange1.1t02288.1", "center": "n"}, {"name": "Cs9g02490.2", "center": "n"}, {"name": "Cs5g23640.1", "center": "n"}, {"name": "Cs6g04450.1", "center": "n"}, {"name": "Cs4g12620.1", "center": "n"}, {"name": "Cs9g07870.2", "center": "n"}, {"name": "Cs3g12970.3", "center": "n"}, {"name": "Cs5g35310.1", "center": "n"}, {"name": "Cs4g02930.1", "center": "n"}, {"name": "Cs8g02310.1", "center": "n"}, {"name": "Cs1g24690.1", "center": "n"}, {"name": "Cs1g14390.3", "center": "n"}, {"name": "Cs3g16020.4", "center": "n"}, {"name": "Cs7g12530.1", "center": "n"}, {"name": "Cs1g21290.3", "center": "n"}, {"name": "Cs7g13950.2", "center": "n"}, {"name": "Cs1g09920.1", "center": "n"}, {"name": "Cs8g03680.2", "center": "n"}, {"name": "orange1.1t00459.3", "center": "n"}, {"name": "Cs7g06850.1", "center": "n"}, {"name": "Cs6g05770.1", "center": "n"}, {"name": "Cs1g17300.1", "center": "n"}, {"name": "Cs5g27040.1", "center": "n"}, {"name": "Cs3g11400.1", "center": "n"}, {"name": "Cs3g16020.1", "center": "n"}, {"name": "Cs2g28930.3", "center": "n"}, {"name": "orange1.1t00459.1", "center": "n"}, {"name": "Cs5g05650.1", "center": "n"}, {"name": "Cs7g08790.1", "center": "n"}, {"name": "Cs7g12520.1", "center": "n"}, {"name": "Cs7g17060.4", "center": "n"}, {"name": "Cs1g26080.1", "center": "n"}, {"name": "Cs3g02590.1", "center": "n"}, {"name": "Cs3g12970.2", "center": "n"}, {"name": "Cs5g26110.2", "center": "n"}, {"name": "Cs7g17060.2", "center": "n"}, {"name": "Cs4g12840.1", "center": "n"}, {"name": "Cs3g11680.6", "center": "n"}, {"name": "Cs1g14390.6", "center": "n"}, {"name": "Cs5g05650.3", "center": "n"}, {"name": "Cs5g27000.2", "center": "n"}, {"name": "Cs6g08840.2", "center": "n"}, {"name": "orange1.1t02345.2", "center": "n"}, {"name": "Cs8g19650.1", "center": "n"}, {"name": "Cs9g17360.1", "center": "n"}, {"name": "Cs3g11680.2", "center": "n"}, {"name": "Cs1g10270.1", "center": "n"}, {"name": "Cs6g19730.2", "center": "n"}, {"name": "Cs1g25690.1", "center": "n"}, {"name": "orange1.1t02721.2", "center": "n"}, {"name": "Cs6g21100.1", "center": "n"}, {"name": "Cs6g02840.2", "center": "n"}, {"name": "Cs9g03530.1", "center": "n"}, {"name": "Cs1g14390.8", "center": "n"}, {"name": "Cs4g03760.1", "center": "n"}, {"name": "Cs9g05750.1", "center": "n"}, {"name": "Cs5g05650.5", "center": "n"}, {"name": "Cs2g08430.1", "center": "n"}, {"name": "Cs6g02840.1", "center": "n"}, {"name": "Cs4g15310.1", "center": "n"}, {"name": "Cs9g15060.1", "center": "n"}, {"name": "Cs1g21050.1", "center": "n"}, {"name": "orange1.1t04186.1", "center": "n"}, {"name": "Cs3g16020.5", "center": "n"}, {"name": "Cs1g09920.3", "center": "n"}, {"name": "Cs7g19120.1", "center": "n"}, {"name": "Cs2g21530.2", "center": "n"}, {"name": "orange1.1t00051.1", "center": "n"}, {"name": "Cs9g01570.1", "center": "n"}, {"name": "Cs8g08200.2", "center": "n"}, {"name": "Cs5g20610.1", "center": "n"}, {"name": "Cs5g13100.1", "center": "n"}, {"name": "Cs9g03120.2", "center": "n"}, {"name": "Cs5g05650.7", "center": "n"}, {"name": "Cs2g27930.2", "center": "n"}, {"name": "Cs8g02310.3", "center": "n"}], "links": [{"source": "orange1.1t04741.1", "target": "Cs2g04850.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g02490.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g10670.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t00168.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g16010.5", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g07670.1", "score2": 3.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g03530.2", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g25060.2", "score2": 3.33960784313725, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs2g09970.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g16020.8", "score2": 1.27619047619048, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g21530.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g10160.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g05750.3", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t02288.1", "score2": 3.33960784313725, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g02490.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g23640.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g04450.1", "score2": 17.4071291795551, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g12620.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g07870.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g12970.3", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g35310.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g02930.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g02310.1", "score2": 2.14285714285714, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g24690.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g14390.3", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g16020.4", "score2": 1.27619047619048, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g12530.1", "score2": 7.66666666666667, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g21290.3", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g13950.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g09920.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g03680.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t00459.3", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g06850.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g05770.1", "score2": 2.73015873015873, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g17300.1", "score2": 3.33960784313725, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g27040.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g11400.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g16020.1", "score2": 1.27619047619048, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs2g28930.3", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t00459.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g05650.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g08790.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g12520.1", "score2": 7.66666666666667, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g17060.4", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g26080.1", "score2": 3.03225806451613, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g02590.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g12970.2", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g26110.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g17060.2", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g12840.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g11680.6", "score2": 0.711827956989247, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g14390.6", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g05650.3", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g27000.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g08840.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t02345.2", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g19650.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g17360.1", "score2": 1.06349206349206, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g11680.2", "score2": 0.711827956989247, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g10270.1", "score2": 3.47619047619047, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g19730.2", "score2": 2.14285714285714, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g25690.1", "score2": 3.33960784313725, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t02721.2", "score2": 5.53046594982079, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g21100.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g02840.2", "score2": 5.55504352278544, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g03530.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g14390.8", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g03760.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g05750.1", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g05650.5", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs2g08430.1", "score2": 1.23809523809524, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs6g02840.1", "score2": 5.55504352278544, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs4g15310.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g15060.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g21050.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t04186.1", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs3g16020.5", "score2": 1.27619047619048, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs1g09920.3", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs7g19120.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs2g21530.2", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "orange1.1t00051.1", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g01570.1", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g08200.2", "score2": 2.11111111111111, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g20610.1", "score2": 3.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g13100.1", "score2": 3.77777777777778, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs9g03120.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs5g05650.7", "score2": 2.0, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs2g27930.2", "score2": 2.33333333333333, "score1": 0.0}, {"source": "orange1.1t04741.1", "target": "Cs8g02310.3", "score2": 2.14285714285714, "score1": 0.0}]}*/
             

var w = 800,h = 600;

var circleWidth = 5;

var fontFamily = 'Bree Serif',
    fontSizeHighlight = '1.5em',
    fontSizeNormal = '1em';

var palette = {
      "lightgray": "#819090",
      "gray": "#708284",
      "mediumgray": "#536870",
      "darkgray": "#475B62",

      "darkblue": "#0A2933",
      "darkerblue": "#042029",

      "paleryellow": "#FCF4DC",
      "paleyellow": "#EAE3CB",
      "yellow": "#A57706",
      "orange": "#BD3613",
      "red": "#D11C24",
      "pink": "#C61C6F",
      "purple": "#595AB7",
      "blue": "#2176C7",
      "green": "#259286",
      "yellowgreen": "#738A05"
  };

function mapNodes(nodes){
  nodesMap = d3.map()       
  nodes.forEach(function(n){
    if (nodesMap.has(n.name)){      
    }
    else{      
      nodesMap.set(n.name,n)
    }
  });
    return nodesMap;
} 


var scale_x = d3.scale.linear().domain([0,w]).range([0,300]);
var scale_y = d3.scale.linear().domain([0,h]).range([h,0]);


function render(ppi_json){  

              nodesMap = mapNodes(ppi_json.nodes);         
              ppi_json.links.forEach(function(l){
                  l.source = nodesMap.get(l.source)
                  l.target = nodesMap.get(l.target)    
              });

              var temp_node = ppi_json.nodes[0].name
              var nodes = ppi_json.nodes.filter(function(n){  
                   return temp_node != n.name || n.center == 'y';
              });              
                                          
              var links = ppi_json.links;


              var vis = d3.select("body")
                    .append("svg:svg")
                    .attr("class", "stage")
                    .attr("width", w)
                    .attr("height", h);

              var force = d3.layout.force()
                  .nodes(nodes)
                  .links([])
                  .gravity(0.1)
                  .charge(-150)
                  .friction(0.95)
                  .linkDistance(50)
                  .linkStrength(1)
                  .size([w-50, h-50]);                  
/*
               var link = vis.selectAll(".link")
                        .data(links)
                        .enter().append("line")
                        .attr("class", "link")
                        .attr("stroke", "#CCC")
                        .attr("fill", "none");*/

               var link = vis.selectAll(".link")
                        .data(links)
                        .enter().append("path")
                        .attr("class", "link")
                        .attr("stroke", "#CCC")
                        .attr("fill", "none");                        
                              
               var node = vis.selectAll("circle.node")
                    .data(nodes)
                    .enter().append("g")
                    .attr("class", "node")
                    //MOUSEOVER
                    .on("mouseover", function(d,i) {
                      if (i>0) {
                        //CIRCLE
                        d3.select(this).selectAll("circle")
                        .transition()
                        .duration(250)
                        .style("cursor", "none")     
                        .attr("r", circleWidth+3)
                        .attr("fill",palette.orange);

                        //TEXT
                        d3.select(this).select("text")
                        .transition()
                        .style("cursor", "none")     
                        .duration(250)
                        .style("cursor", "none")     
                        .attr("font-size","1.5em")
                        .attr("x", 15 )
                        .attr("y", 5 )
                        
                        //show the detail info about the this protein
                        d3.select("#tooltip")
                          .style("left",(d3.event.pageX + 5) + "px")
                          .style("top",(d3.event.pageY + 5) + "px")                         
                          .select("#value").text(d.name);                        
                        d3.select("#tooltip").classed("hidden", false);
                      } else {
                        //CIRCLE
                        d3.select(this).selectAll("circle")
                        .style("cursor", "none")     

                        //TEXT
                        d3.select(this).select("text")
                        .style("cursor", "none")     
                      }
                    })

                    //MOUSEOUT
                    .on("mouseout", function(d,i) {
                      if (i>0) {
                        //CIRCLE
                        d3.select(this).selectAll("circle")
                        .transition()
                        .duration(250)
                        .attr("r", circleWidth)
                        .attr("fill",palette.pink);

                        //TEXT
                        d3.select(this).select("text")
                        .transition()
                        .duration(250)
                        .attr("font-size","1em")
                        .attr("x", 8 )
                        .attr("y", 4 )

                        //hidden the protein detail
                        d3.select("#tooltip").classed("hidden", true);
                      }
                    })                    
                    //CLICK 
                    .on("click",function(d,i){
                        console.log('click')
                       
                    })                                    
                    .on('dblclick',function(d,i){
                        d3.select("#tooltip").classed("hidden", true);
                        console.log('dbclick')
                        protein = d.name;
                        var ajaxsrc='json?'+'protein='+protein;
                        $('.stage').remove();
                        console.log(ajaxsrc);
                        d3.json(ajaxsrc)
                          .on("beforesend", function(request) { request.withCredentials = true; })
                          .get(function(error,json){                            
                            $('#submit').attr('disabled', false);
                            ppi_json = json;
                            render(ppi_json);             
                          });                         
                    })                    
                    .call(force.drag);

                  //CIRCLE
                  node.append("svg:circle")
                    .attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; })
                    .attr("r", circleWidth)
                    .attr("fill", function(d, i) { if (i>0) { return  palette.pink; } else { return palette.paleryellow } } )

                  //TEXT
                  node.append("text")
                    .text(function(d, i) { 
                        if (d.center == 'y'){
                            d.fixed = true;                            
                            d.px = w/2;
                            d.py = h/2;
                        }
                      return d.name; 
                    })
                    .attr("x",            function(d, i) { if (i>0) { return circleWidth + 5; }   else { return -10 } })
                    .attr("y",            function(d, i) { if (i>0) { return circleWidth + 0 }    else { return 8 } })
                    .attr("font-family",  "Bree Serif")
                    .attr("fill",         function(d, i) { if (i>0) { return  palette.paleryellow; }        else { return palette.yellowgreen } })
                    .attr("font-size",    function(d, i) { if (i>0) { return  "1em"; }            else { return "1.8em" } })
                    .attr("text-anchor",  function(d, i) { if (i>0) { return  "beginning"; }      else { return "end" } })



/*              force.on("tick", function(e) {
                node.attr("transform", function(d, i) {     
                      if (d.center == 'y'){
                          return "translate(" + d.x + "," + d.y + ")"; 
                      } 
                      return "translate(" + d.x + "," + d.y + ")";                      
                  });

                  link.attr("x1", function(d)  { return d.source.x; })
                     .attr("y1", function(d)   { return d.source.y; })
                     .attr("x2", function(d)   { return d.target.x; })
                     .attr("y2", function(d)   { return d.target.y; })
                  });*/

               force.on("tick", function(e) {
                  node.attr("transform", function(d, i) {     
                      if (d.center == 'y'){
                          return "translate(" + d.x + "," + d.y + ")"; 
                      } 
                      return "translate(" + d.x + "," + d.y + ")";                      
                  });

/*                  link.attr("x1", function(d)  { return d.source.x; })
                     .attr("y1", function(d)   { return d.source.y; })
                     .attr("x2", function(d)   { return d.target.x; })
                     .attr("y2", function(d)   { return d.target.y; })
*/
                  link.attr("d", function(d) {
                        var x1 = d.source.x,
                            y1 = d.source.y,
                            x2 = d.target.x,
                            y2 = d.target.y,
                            dx = x2 - x1,
                            dy = y2 - y1,
                            dr = Math.sqrt(dx * dx + dy * dy),

                            // Defaults for normal edge.
                            drx = dr,
                            dry = dr,
                            xRotation = 0, // degrees
                            largeArc = 0, // 1 or 0
                            sweep = 1; // 1 or 0

                            // Self edge.
                            if ( x1 === x2 && y1 === y2 ) {
                              // Fiddle with this angle to get loop oriented.
                              xRotation = -45;

                              // Needs to be 1.
                              largeArc = 1;

                              // Change sweep to change orientation of loop. 
                              //sweep = 0;

                              // Make drx and dry different to get an ellipse
                              // instead of a circle.
                              drx = 30;
                              dry = 20;
                              
                              // For whatever reason the arc collapses to a point if the beginning
                              // and ending points of the arc are the same, so kludge it.
                              x2 = x2 + 1;
                              y2 = y2 + 1;
                            } 

                       return "M" + x1 + "," + y1 + "A" + drx + "," + dry + " " + xRotation + "," + largeArc + "," + sweep + " " + x2 + "," + y2;
                      });
                 });

              force.start();
}